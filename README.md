# DevOps Engineer Challenge - HTTP Based API

[![CircleCI](https://circleci.com/gh/Nikos-K/devops-api-challenge.svg?style=svg)](https://circleci.com/gh/Nikos-K/devops-api-challenge)
[![serverless](http://public.serverless.com/badges/v3.svg)](http://www.serverless.com)


## Solution Overview & Toolstack
![HomePage](https://github.com/Nikos-K/devops-api-challenge/blob/master/img/architecture.jpg)

This project makes use of the following toolstack in order to built, test and deploy a highly available& scalable "Hello World" application. Built-in features include: zero-downtime automated deployments, canary type deployments for the prod environment, automated roll-backs, integrated testing (linting, unit, integration), aggregated logging and monitoring.

**Toolstack**
* [Serverless](https://serverless.com/framework/docs/): is a CLI tool that allows users to build & deploy event-driven serverless microservices on different cloud providers. It was chosen for this project as it allowed to quickly build and deploy an API application that is highly available & scalable in AWS, as well as to benefit from plugins providing features such as Canary deployments. The serverless deployment code is stored in the [serverless.yml](serverless.yml) file.
* `Github`: It is used as the SCM tool for this project and all the source code is stored under the current repository.
* [CircleCI](https://circleci.com): It is used as the orchestrating tool for all the CI/CD pipelines in this project. The CircleCI pipeline definition is stored in the [.circleci/config.yml](.circleci/config.yml) file.
* `AWS`: All the infrastructure required for the application it is hosted on AWS. We are making use of several AWS services such as CloudFront, API Gateway, Lambda, CloudWatch, CodeDeploy and DynamoDB.
* `NodeJS`: Nodejs8.10 was used as a runtime for the Lambda functions. The main Hello World application code is stored in the [index.js](index.js) file.
* [StandardJS](https://standardjs.com): As a linting tool.


### API Deployment Workflow
![HomePage](https://github.com/Nikos-K/devops-api-challenge/blob/master/img/workflow.jpg)

Note: As part of this PoC, a [GitHub Flow](https://guides.github.com/introduction/flow/) like approach is being used:
* There are 4 different branches:
    - master => No direct pushes are allowed to this branch. This branch is used to trigger deployments in the prod environment. 
    - develop => This branch is used to trigger deployments in the dev environment.
    - remove-prod => This branch is used to trigger the deletion of the prod environment.
    - remove-dev => This branch is used to trigger the deletion of the prod environment.


**Deployment Workflow for Dev Environment**
1. The Dev pipeline in CircleCI is triggered when a developer pushes code into the develop branch of the repo.
2. The first step of the Dev pipeline is to trigger setup the environment and checkout the code from the develop branch.
3. The next step is to install the Serverless CLI as well as any other dependencies and plugins using npm.
4. In this step the pipeline executes linting on the index.js script using StandardJS.
5. Here we perform unit testing on the index.js script.
6. Finally the Hello World application is deployed in AWS via Serverless. From then on, the Serverless framework takes care of the configuration details across different AWS services, which required as part of the application deployment. Note: As it can be noticed in the [serverless.yml](serverless.yml) script, this solution is making use of the serverless serverless canary-deployments plugin. The plugin relies on the AWS Lambda traffic shifting feature to balance traffic between versions and AWS CodeDeploy to automatically update its weight. It modifies the CloudFormation template generated by Serverless, so that:
* It creates a Lambda function Alias for each function with deployment settings.
* It creates a CodeDeploy Application and adds a CodeDeploy DeploymentGroup per Lambda function, according to the specified settings. For the Dev environment the traffic will be shifted between the Lambda function versions using the AllAtOnce type, and in the Prod environment using the Canary10Percent5Minutes type.
* It modifies the events that trigger the Lambda functions, so that they invoke the newly created alias.
* Provides CodeDeploy with a list of alarms to track during the deployment process. In case any of them turn into ALARM state, then it cancels the deployment and shifts all the traffic to the old version.
* Uses Pre and Post Hooks as Lambda functions. These are triggered by CodeDeploy before and after traffic shifting takes place. It expects to get notified about the success or failure of the hook, only continuing to the next step if it succeeded. These hooks are usefull for running end-to-end or integration tests and checking that all the pieces fit together in the cloud, since it'll automatically roll back upon failure.

**Deployment Workflow for Prod Environment**

1. A Developer creates a PR from the develop branch into the master branch. Note: Direct push into the master branch should not be allowed by any user.
2. PR is reviewed, and if it is accepted, then the Prod Pipeline in CircleCI is triggered.
3. The rest of the pipeline follows a similar process to the steps (3-6) described for the Dev pipeline above.

**Dev & Prod Environment Removal Workflow**

1. A developer pushes an empty commit into the remote-dev (remote-prod for prod environment) branch to trigger the removal pipeline in CircleCI.
2. The first step of pipeline is a hold type of job. The pipeline will freeze until the user interactively confirm the deletion of the environment from the CircleCi console.
3. Once the deletion of the environment is approved, the next step is to setup the environment and checkout the code from the develop branch (or prod branch).
4. The next step is to install the Serverless CLI as well as any other dependencies and plugins using npm.
5. Finally, the environment is removed from AWS using the Serverless CLI remove command.


### Setup Instructions
**Pre-requisites**
1. An AWS account with a user given admin level programmatic access.
2. A github account with access to this repo.
3. A CircleCI account, authorized to access the Github repo so that it can run the CI/CD pipelines.

**Setup Steps**
1. Under the project's settings in CircleCI add your AWS user credentials (There should be an option under AWS permissions). It is a good practice to create a new user, which will be used only by CircleCI.
2. After setting up the integration between CircleCI and this repo in Github, you should be able to start using the workflow described above to deploy the Hello World application. CircleCI should have automatically picked up the Pipeline definition from the [.circleci.config.yml](.circleci/config.yml) script present in this repo.

**Steps to Test the Hellow World Application**
1. Deploy the application in the dev environment by pushing some code into the develop branch of the repo. For testing purposes an empty commit can be used. ex. `git commit --allow-empty -m "Trigger dev deletion"`
2. Monitor the deployment of the application through the CircleCI console. When the pipeline finishes you should be able to see the ServiceEndpoint of the new API. The output should look similar to the following screenshot: ![HomePage](https://github.com/Nikos-K/devops-api-challenge/blob/master/img/api-endpoint.jpg)
3. Use the api endpoint to test adding a new user to the application, with his dob same as current date: `curl -X PUT -H "Content-Type: application/json" -d '{"dateOfBirth":"1998-09-16"}' https://bb70henpfe.execute-api.eu-west-1.amazonaws.com/dev/hello/Mario`
4. Use the api endpoint to test adding a new user to the application with his dob 5 days from today: `curl -X PUT -H "Content-Type: application/json" -d '{"dateOfBirth":"1998-09-21"}' https://bb70henpfe.execute-api.eu-west-1.amazonaws.com/dev/hello/Luigi`
5. Use the api endpoint to test retrieving the information about the user having his birthday today: `curl https://bb70henpfe.execute-api.eu-west-1.amazonaws.com/dev/hello/Mario`
6. Use the api endpoint to test retrieving the information about the user having his birthday in 5 days: `curl https://bb70henpfe.execute-api.eu-west-1.amazonaws.com/dev/hello/Luigi`

### Considerations
Due to the scope & time constraints for this PoC, the following points could be considered in order to further improve the quality of the solution:

* Unit Testing: Although a step has been added as part of the CircleCI pipeline to accommodate unit tests, the scripts have not been completed as part of this PoC. A testing framework such as Mocha could be used for testing the nodejs function. 
* Integration Testing: The pre and post hooks that have been added as part of the current serverless configuration, could be developed further in order to run end-to-end or integration tests.
* Reduced CI/CD times: The deployment times as part of the pipeline could be reduced by making use of the CircleCi feature of [Caching Dependencies](https://circleci.com/docs/2.0/caching/) from the previous builds and/or parallel builds. Moreover, using the [sls package](https://serverless.com/framework/docs/providers/aws/cli-reference/package/) command before using the sls deploy command could further improve the deployment time, transparency and traceability. Other performance improvement could be realised by using different settings for the AWS DynamoDB, API Gateway and Lambda services.
* Monitoring & Alerting: Additional alerts could be configured in CloudWatch based on different Lambda function metrics (ex. Invocations, Throttles, Duration, etc.. ). Moreover, these alerts as well as others from CircleCI could be sent into users through SNS or Slack notifications.
* Security: Many features could be implemented to improve the security posture of this solution. For example, an API key could be configured and required as part of the API Gateway. Also, AWS Cognito could be integrated as part of this solution for user management. Another security consideration could be the handling of the CircleCI user (rotating keys, limit service access, etc..) as well as the use of complete different AWS accounts, regions for different environments.
* Stable API Domain: The [serverless-domain-manager plugin](https://github.com/amplify-education/serverless-domain-manager) could be used in order to use custom domain when deploying the application with serverless.